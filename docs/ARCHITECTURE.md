# ARQUITECTURA DEL PROJECTE TEXTAMI

**Data:** 24 Agost 2025  
**Versi√≥:** 0.1.0-ai-first  
**Status:** Fase 1 - Intel¬∑lig√®ncia Artificial en Desenvolupament

---

## üéØ VISI√ì ARQUITECT√íNICA

Textami utilitza una **arquitectura AI-first** amb un enfocament modular que evita el deute t√®cnic posposant la decisi√≥ del motor de generaci√≥ final fins tenir tota la informaci√≥ necess√†ria.

## üèóÔ∏è ESTRAT√àGIA DE DESENVOLUPAMENT

### **Principi Fonamental:**
**AI-First, Docxtemplater-Last** - Desenvolupar tota la intel¬∑lig√®ncia artificial i interf√≠cie abans de decidir el motor de generaci√≥ de documents final.

### **Arquitectura de 4 Fases:**

```mermaid
graph LR
    A[Fase 1: IA] --> B[Fase 2: UI]
    B --> C[Fase 3: Backend]
    C --> D[Fase 4: DECISI√ì]
    D -->|Opci√≥ A| E[Docxtemplater Std]
    D -->|Opci√≥ B| F[Docxtemplater Premium]
    D -->|Opci√≥ C| G[Alternatives]
```

#### **Fase 1: Intel¬∑lig√®ncia Artificial (ACTUAL)**
```typescript
// Capa d'IA completament independent
interface AIServices {
  documentAnalysis: DocumentAnalysisService
  placeholderDetection: PlaceholderDetectionService  
  intelligentMapping: MappingService
  contentValidation: ValidationService
}
```

#### **Fase 2: Interf√≠cie d'Usuari (SEG√úENT)**  
```typescript
// UI agn√≤stica al motor de generaci√≥
interface UILayer {
  layout: ThreePanelLayout
  workflow: WorkflowManager
  preview: MockDocumentPreview  // Mockejada fins decidir motor
}
```

#### **Fase 3: Backend Agn√≤stic (DESPR√âS UI)**
```typescript
// Factory pattern per intercanviabilitat
interface DocumentGenerator {
  initialize(config: GeneratorConfig): Promise<void>
  generateDocument(template: Buffer, data: any): Promise<Buffer>
  supportedFeatures(): Feature[]
}
```

#### **Fase 4: DECISI√ì + Motor Espec√≠fic (FINAL)**
- Avaluar opcions amb context complet
- Implementar motor escollit 
- Zero refactoring de fases anteriors

---

## üîß STACK TECNOL√íGIC ACTUAL

### **Frontend:**
```json
{
  "framework": "Next.js 15.4.6",
  "runtime": "React 19.1.0", 
  "language": "TypeScript 5.0",
  "styling": "Tailwind CSS 4.0",
  "state": "Zustand (planned)",
  "animations": "Framer Motion (planned)"
}
```

### **Backend:**
```json
{
  "runtime": "Node.js + Next.js API Routes",
  "database": "Supabase PostgreSQL",
  "storage": "Supabase Storage", 
  "auth": "Supabase Auth",
  "ai": "OpenAI GPT-5 Vision API"
}
```

### **Infrastructure:**
```json
{
  "hosting": "Vercel",
  "domain": "TBD",
  "monitoring": "Vercel Analytics",
  "errors": "Built-in Next.js error handling"
}
```

---

## üìä ARQUITECTURA DE DADES

### **Database Schema (Supabase):**

```sql
-- Templates and AI Analysis
CREATE TABLE templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  file_name TEXT NOT NULL,
  storage_path TEXT NOT NULL,
  placeholders JSONB,
  ai_analysis JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Excel Data Sources  
CREATE TABLE data_sources (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  file_name TEXT NOT NULL,
  storage_path TEXT NOT NULL,
  columns JSONB,
  sample_data JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Generation Jobs
CREATE TABLE generations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  template_id UUID REFERENCES templates(id),
  data_source_id UUID REFERENCES data_sources(id),
  mappings JSONB,
  status TEXT DEFAULT 'pending',
  results JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Usage Analytics
CREATE TABLE usage_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  action TEXT NOT NULL,
  metadata JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### **TypeScript Types:**

```typescript
// Core Types
interface Template {
  id: string
  userId: string
  fileName: string
  storagePath: string
  placeholders: Placeholder[]
  aiAnalysis: AIAnalysis
  createdAt: Date
}

interface Placeholder {
  text: string
  type: 'string' | 'number' | 'date' | 'email' | 'phone' | 'address'
  confidence: number
  position: string
  reasoning: string
}

interface Mapping {
  placeholder: string
  excelColumn: string
  confidence: number
  validated: boolean
}
```

---

## üåê API ARCHITECTURE

### **Current Endpoints (Fase 1):**

```typescript
// Document Analysis
POST /api/ai-docx/analyze
  Input: FormData (docx file)
  Output: { placeholders, transcription, analysis }

// Excel Processing  
POST /api/ai-docx/excel
  Input: FormData (excel file)
  Output: { columns, sampleData, metadata }

// Mapping Intelligence
POST /api/ai-docx/mapping  
  Input: { placeholders, columns }
  Output: { mappings, confidence, recommendations }

// Document Generation (mockejada)
POST /api/ai-docx/generate
  Input: { templateId, mappings, data }
  Output: { jobId, status, preview }
```

### **Future Endpoints (Fase 4):**

```typescript
// Real Document Generation  
POST /api/generate/docx
  Input: { templateId, mappings, data, format }
  Output: { documentUrl, metadata }

// Batch Processing
POST /api/generate/batch
  Input: { templateId, mappings, dataArray }
  Output: { jobId, status, progress }

// Template Management
GET/POST/PUT/DELETE /api/templates/{id}
  CRUD operations per templates
```

---

## üîå INTEGRATIONS

### **OpenAI Integration:**
```typescript
// AI Services Configuration
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
  organization: process.env.OPENAI_ORG_ID
})

// Models Used
const AI_MODELS = {
  documentAnalysis: "gpt-4o", // GPT-5 equivalent
  contentGeneration: "gpt-4o", 
  textEmbedding: "text-embedding-3-small"
}
```

### **Supabase Integration:**
```typescript
// Database Clients
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs'
import { createServerComponentClient } from '@supabase/auth-helpers-nextjs'

// Row Level Security enabled
// Storage buckets configured per user
```

---

## üèõÔ∏è COMPONENT ARCHITECTURE

### **Current Structure:**
```
/app/
‚îú‚îÄ‚îÄ api/ai-docx/          # AI Processing APIs
‚îú‚îÄ‚îÄ generator/            # MVP UI (current)
‚îî‚îÄ‚îÄ layout.tsx           # Root layout

/components/
‚îú‚îÄ‚îÄ ui/                  # Base UI components
‚îú‚îÄ‚îÄ AuthForm.tsx         # Authentication
‚îî‚îÄ‚îÄ SessionProvider.tsx  # Auth context

/lib/
‚îú‚îÄ‚îÄ documents/           # File processing utilities
‚îú‚îÄ‚îÄ supabase/           # Database clients  
‚îî‚îÄ‚îÄ utils/              # Shared utilities
```

### **Future Structure (Fase 2):**
```
/app/
‚îú‚îÄ‚îÄ api/                 # Current + new endpoints
‚îú‚îÄ‚îÄ generator/           # Current MVP
‚îú‚îÄ‚îÄ generator-v2/        # Advanced 3-panel UI
‚îî‚îÄ‚îÄ layout.tsx

/components/
‚îú‚îÄ‚îÄ textami/            # Advanced components
‚îÇ   ‚îú‚îÄ‚îÄ layout/         # 3-panel layout
‚îÇ   ‚îú‚îÄ‚îÄ workflow/       # Workflow management
‚îÇ   ‚îú‚îÄ‚îÄ document/       # Document viewer
‚îÇ   ‚îú‚îÄ‚îÄ fields/         # Field mapping
‚îÇ   ‚îî‚îÄ‚îÄ ai/            # AI interactions
‚îî‚îÄ‚îÄ ui/                # Base components

/lib/
‚îú‚îÄ‚îÄ generators/         # Abstract generator interfaces
‚îú‚îÄ‚îÄ ai/                # AI service layer
‚îî‚îÄ‚îÄ state/             # State management
```

---

## üîß DEVELOPMENT PATTERNS

### **Factory Pattern per Generators:**
```typescript
interface DocumentGenerator {
  initialize(config: GeneratorConfig): Promise<void>
  generateDocument(template: Buffer, data: any): Promise<Buffer>
  supportedFeatures(): Feature[]
  validateTemplate(template: Buffer): Promise<ValidationResult>
}

class GeneratorFactory {
  static create(type: GeneratorType): DocumentGenerator {
    switch(type) {
      case 'DOCXTEMPLATER_STANDARD':
        return new DocxtemplaterStandardGenerator()
      case 'DOCXTEMPLATER_PREMIUM':
        return new DocxtemplaterPremiumGenerator() 
      case 'CARBONE':
        return new CarboneGenerator()
      case 'CUSTOM':
        return new CustomAIGenerator()
      default:
        throw new Error(`Unsupported generator type: ${type}`)
    }
  }
}
```

### **Error Handling Strategy:**
```typescript
// Consistent error handling across APIs
interface APIResponse<T> {
  success: boolean
  data?: T
  error?: {
    code: string
    message: string
    details?: any
  }
  metadata?: {
    processingTime: number
    usage?: AIUsage
  }
}
```

### **State Management (Planned):**
```typescript
// Zustand store for application state
interface TextamiStore {
  // Workflow
  currentStep: WorkflowStep
  setCurrentStep: (step: WorkflowStep) => void
  
  // Documents  
  template: Template | null
  excelData: ExcelData | null
  mappings: Mapping[]
  
  // UI State
  loading: boolean
  errors: Record<string, string>
}
```

---

## üöÄ DEPLOYMENT ARCHITECTURE

### **Vercel Deployment:**
```javascript
// vercel.json
{
  "functions": {
    "app/api/**/*.ts": {
      "maxDuration": 30
    }
  },
  "env": {
    "OPENAI_API_KEY": "@openai-key",
    "SUPABASE_URL": "@supabase-url", 
    "SUPABASE_ANON_KEY": "@supabase-anon"
  }
}
```

### **Environment Configuration:**
```bash
# Development
OPENAI_API_KEY=sk-...
SUPABASE_URL=https://...
SUPABASE_ANON_KEY=eyJ...
DATABASE_URL=postgresql://...

# Production  
# Same variables managed via Vercel dashboard
```

---

## üéØ DECISIONS ARQUITECT√íNIQUES

### **‚úÖ Decisions Preses:**
1. **Next.js 15.4.6** com framework principal
2. **Supabase** per backend-as-a-service
3. **OpenAI GPT-5** per intel¬∑lig√®ncia artificial
4. **Factory Pattern** per motors de generaci√≥
5. **TypeScript strict** per type safety

### **üîÑ Decisions Pendents (Fase 4):**
1. **Motor de Generaci√≥:** Docxtemplater vs alternatives
2. **Premium Features:** Contractar m√≤duls avan√ßats vs funcionalitats b√°siques
3. **UI Complexity:** MVP enhanced vs Professional 3-panel
4. **Pricing Model:** Freemium vs subscription vs pay-per-use

### **üìù Criteris per Futures Decisions:**
- **ROI calculable** per cada opci√≥
- **User research** amb prototips funcionals  
- **Technical debt** minimitzat
- **Scalability** i maintainability
- **Time to market** optimitzat

---

*Aquesta arquitectura assegura flexibilitat m√†xima i decisions informades mentre es construeix un MVP funcional amb valor real.*